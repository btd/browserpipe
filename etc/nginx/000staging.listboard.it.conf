server {
    server_name   www.000staging.listboard.it;
    return 301 http://$server_name$request_uri;
}

upstream app-staging {
    server 127.0.0.1:4001;
}

server {

    server_name     000staging.listboard.it;

    proxy_next_upstream error timeout http_502 http_503;

    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_read_timeout 700;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block;";

    location / {
        #'access_log' within 'if' is only allowed within 'location'
        if ( $http_user_agent ~* (bot|crawl|\+http:)) {
            access_log /var/log/nginx/$host.bots.log;
        }

        try_files $uri @proxy;
    }

    location @proxy {
        proxy_pass http://app-staging;
    }

    location ~ ^/(css|js|img)/ {
        expires 1y;

        root /home/staging_listboard_it;

        try_files /builtAssets$uri /public$uri =404;
    }

    location = /favicon.ico {
        access_log off;
        log_not_found off;
        expires 1y;

        root /home/staging_listboard_it/public;
        try_files $uri =404;
    }
    location ~* /apple-touch-icon.*\.png {
        access_log off;
        log_not_found off;
        expires 7d;

        #empty_gif;
        return 204;
    }

    location ~* ^.+\.(jpg|gif|png|css|js|swf|ico)$ {
        access_log      off;
        log_not_found   off;
        expires         1y;
    }

    location ~ (?:/\..*|~)$ {
        access_log off;
        log_not_found off;
        deny all;
    }

    # Prevent clients from accessing hidden files (starting with a dot)
    # This is particularly important if you store .htpasswd files in the site hierarchy
    location ~* (?:^|/)\. {
        deny all;
    }

    # Prevent clients from accessing to backup/config/source files
    location ~* (?:\.(?:bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~)$ {
        deny all;
    }
}
