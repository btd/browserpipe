var config = require('../../config');

//Bookmarklet
exports.bookmarklet = function (req, res, next) {
  res.render('modals/bookmarklet', {
    code: 'javascript:(function(e){var t="' + config.appUrl + '";if(t!==location.protocol+"//"+location.host){var n=e.document;setTimeout(function(){function s(e){return encodeURIComponent(e).replace(/%20/g,"+")}function o(r,i){var o=new XMLHttpRequest;o.open("POST",t+"/bookmarklet/add",true);o.setRequestHeader("Content-type","application/x-www-form-urlencoded");o.withCredentials=true;o.onreadystatechange=function(){if(i&&o.readyState==4)i(JSON.parse(o.responseText)._id)};o.send("url="+s(e.location.href)+"&parent="+r+"&title="+s(n.title)+"&width="+s(n.documentElement.clientWidth)+"&height="+s(n.documentElement.clientHeight)+"&html="+s(n.documentElement.innerHTML)+"&charset="+s(n.characterSet)+"&v=1.1")}function u(){var e=n.getElementById(r);if(e){n.body.removeChild(e);e=null}}function a(e){if(e)c.style.width="90%";else c.style.width="269px"}function f(e){if(e.origin!==t)return;if(e.data.substring(0,5)==="save_")o(e.data.substring(5));else switch(e.data){case"expand":a(true);break;case"collapse":a(false);break;case"destroy":u();break}}var r="BPIPE_bookmarklet_iframe",i=n.getElementById(r);if(i){return}var l=n.createElement("div");var c=n.createElement("iframe");c.id=r;c.src=t+"/item/' + req.user.browser + '";l.innerHTML="<div style=\'position:absolute;margin:auto;top:0;right:0;bottom:0;left:0;width:48px;height:48px;z-index:-100;\'><img src=\'"+t+"/img/loader.gif\'/></div>";l.style.backgroundColor="#FFF";l.style.position=c.style.position="fixed";l.style.top=c.style.top="0";l.style.right=c.style.right="0";l.style.height=c.style.height="100%";l.style.width=c.style.width="269px";l.style.zIndex=c.style.zIndex="1999999999";l.style.borderLeft=c.style.borderLeft="6px solid #ff6d16";l.style.borderRight=c.style.borderRight=l.style.borderTop=c.style.borderTop=l.style.borderBottom=c.style.borderBottom="none";c.style.visibility="hidden";c.onload=function(){this.style.visibility="visible";n.body.removeChild(l);l=null};n.body.appendChild(l);n.body.appendChild(c);var h=e.addEventListener?"addEventListener":"attachEvent";var p=h=="attachEvent"?"onmessage":"message";e[h](p,f,false)},1)}})(window)'
  })
}
