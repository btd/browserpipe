(function (window, document, location, documentElement) {
  //THIS VARIABLE IS AUTOGENERATED
  var domain = "<%= config.appUrl %>";
  if (domain !== location.protocol + "//" + location.host) { //WE DO NOT RUN IT ON BROWSERPIPE
    var d = document.createElement("div");
    var html = documentElement.outerHTML;
    setTimeout(function () {
      var bid = "BPIPE_bookmarklet_iframe", elem = document.getElementById(bid);
      if (elem) {
        return
      }
      function encode(data) {
        return encodeURIComponent(data).replace(/%20/g, "+");
      }

      function save(success) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", domain + "/bookmarklet/add", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.withCredentials = true;
        xhr.onreadystatechange = function () {
          if (success && xhr.readyState == 4) success(JSON.parse(xhr.responseText)._id);
        };
        xhr.send("url=" + encode(location.href) + "&title=" + encode(document.title) + "&width=" + encode(documentElement.clientWidth) + "&height=" + encode(documentElement.clientHeight) + "&html=" + encode(html) + "&charset=" + encode(document.characterSet) + "&v=1.1");
      }

      function setDivElement(element) {
        d.innerHTML = "<div style='position:absolute;margin:auto;top:0;right:0;bottom:0;text-align:center;width:100%;height:48px;z-index:-100;font-size: 24px;font-weight: bold;color: #ff6d16;'>" + element + "</div>";
      }

      function done(id) {
        setDivElement("Redirecting...");
        window.location = domain + "/item/" + id;
      }

      function process(e) {
        if (e.origin !== domain) return;
        switch (e.data) {
          case "save":
          {
            //Remove iframe
            var elem = document.getElementById(bid);
            if (elem) {
              document.body.removeChild(elem);
              elem = null;
            }
            //Saving
            setDivElement("Adding...");
            save(done);
            break;
          }
        }
      }

      var s = document.createElement("iframe");
      s.id = bid;
      s.src = domain + "/bookmarklet/open";
      setDivElement("<img src='<%= config.appUrl + url('img/loader.gif') %>'/>");
      d.style.backgroundColor = "#FFF";
      d.style.position = s.style.position = "fixed";
      d.style.top = s.style.top = "0";
      d.style.right = s.style.right = "0";
      d.style.height = s.style.height = "100%";
      d.style.width = s.style.width = "269px";
      d.style.zIndex = s.style.zIndex = "1999999999";
      d.style.borderLeft = s.style.borderLeft = "6px solid #ff6d16";
      d.style.borderRight = s.style.borderRight = d.style.borderTop = s.style.borderTop = d.style.borderBottom = s.style.borderBottom = "none";
      s.style.visibility = "hidden";
      s.onload = function () {
        this.style.visibility = "visible";
      };
      document.body.appendChild(d);
      document.body.appendChild(s);
      var o = s.addEventListener ? "addEventListener" : "attachEvent";
      var u = o == "attachEvent" ? "onmessage" : "message";
      e[o](u, process, false)
    }, 1);
  }
})(window, document, location, document.documentElement);
